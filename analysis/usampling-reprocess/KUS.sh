#!/bin/bash
#OAR -l nodes=1/thread=16,walltime=12:00:00 
#OAR -p virt='YES' AND cluster='armada'
#OAR -O /temp_dd/igrida-fs1/macher/usampling/oar_output/job.%jobid%.output
#OAR -E /temp_dd/igrida-fs1/macher/usampling/oar_output/job.%jobid%.error

. /etc/profile.d/modules.sh

set -x

module load spack/gvirt

VM_NAME=vm-${OAR_JOBID}

gvirt start ${VM_NAME} --image /srv/tempdd/macher/usampling/docker-alpine-usampling.qcow2

VM_WAIT_DOCKER="until [ -S /var/run/docker.sock ]; do sleep 1; done"

BENCH="/home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring24.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring12.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring1.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring4.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring9.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring6.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring2.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring28.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring21.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring22.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring14.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring5.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring10.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring7.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring16.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring3.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring8.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring11.cnf /home/samplingfm/Benchmarks/Blasted_Real/blasted_squaring29.cnf /home/samplingfm/Benchmarks/FeatureModels/XSEngine.cnf /home/samplingfm/Benchmarks/FeatureModels/viper.cnf /home/samplingfm/Benchmarks/FeatureModels/phycore.cnf /home/samplingfm/Benchmarks/FeatureModels/cq7708.cnf /home/samplingfm/Benchmarks/FeatureModels/aeb.cnf /home/samplingfm/Benchmarks/FeatureModels/sh7708.cnf /home/samplingfm/Benchmarks/FeatureModels/vrc4375.cnf /home/samplingfm/Benchmarks/FeatureModels/malta_mips32_4kc.cnf /home/samplingfm/Benchmarks/FeatureModels/rattler.cnf /home/samplingfm/Benchmarks/FeatureModels/asb2305.cnf /home/samplingfm/Benchmarks/FeatureModels/pc_usb_d12.cnf /home/samplingfm/Benchmarks/FeatureModels/vads.cnf /home/samplingfm/Benchmarks/FeatureModels/se77x9.cnf /home/samplingfm/Benchmarks/FeatureModels/se7751.cnf /home/samplingfm/Benchmarks/FeatureModels/mb93093.cnf /home/samplingfm/Benchmarks/FeatureModels/lpcmt.cnf /home/samplingfm/Benchmarks/FeatureModels/integrator_arm7.cnf /home/samplingfm/Benchmarks/FeatureModels/mb93091.cnf /home/samplingfm/Benchmarks/FeatureModels/eb42.cnf /home/samplingfm/Benchmarks/FeatureModels/ea2468.cnf /home/samplingfm/Benchmarks/FeatureModels/cma230.cnf /home/samplingfm/Benchmarks/FeatureModels/olpch2294.cnf /home/samplingfm/Benchmarks/FeatureModels/dreamcast.cnf /home/samplingfm/Benchmarks/FeatureModels/excalibur_arm9.cnf /home/samplingfm/Benchmarks/FeatureModels/nano.cnf /home/samplingfm/Benchmarks/FeatureModels/aki3068net.cnf /home/samplingfm/Benchmarks/FeatureModels/integrator_arm9.cnf /home/samplingfm/Benchmarks/FeatureModels/prpmc1100.cnf /home/samplingfm/Benchmarks/FeatureModels/edb7xxx.cnf /home/samplingfm/Benchmarks/FeatureModels/skmb91302.cnf /home/samplingfm/Benchmarks/FeatureModels/grg.cnf /home/samplingfm/Benchmarks/FeatureModels/jmr3904.cnf /home/samplingfm/Benchmarks/FeatureModels/pc_i82559.cnf /home/samplingfm/Benchmarks/FeatureModels/ref4955.cnf /home/samplingfm/Benchmarks/FeatureModels/mbx.cnf /home/samplingfm/Benchmarks/FeatureModels/sam7ex256.cnf /home/samplingfm/Benchmarks/FeatureModels/phycore229x.cnf /home/samplingfm/Benchmarks/FeatureModels/innovator.cnf /home/samplingfm/Benchmarks/FeatureModels/ts6.cnf /home/samplingfm/Benchmarks/FeatureModels/aim711.cnf /home/samplingfm/Benchmarks/FeatureModels/aaed2000.cnf /home/samplingfm/Benchmarks/FeatureModels/picasso.cnf /home/samplingfm/Benchmarks/FeatureModels/olpcl2294.cnf /home/samplingfm/Benchmarks/FeatureModels/pc_i82544.cnf /home/samplingfm/Benchmarks/FeatureModels/olpce2294.cnf /home/samplingfm/Benchmarks/FeatureModels/stdeval1.cnf /home/samplingfm/Benchmarks/FeatureModels/pc_rltk8139.cnf /home/samplingfm/Benchmarks/FeatureModels/adder.cnf /home/samplingfm/Benchmarks/FeatureModels/pid.cnf /home/samplingfm/Benchmarks/FeatureModels/iq80310.cnf /home/samplingfm/Benchmarks/FeatureModels/adderII.cnf /home/samplingfm/Benchmarks/FeatureModels/cerf.cnf /home/samplingfm/Benchmarks/FeatureModels/npwr.cnf /home/samplingfm/Benchmarks/FeatureModels/cerfpda.cnf /home/samplingfm/Benchmarks/FeatureModels/at91sam7xek.cnf /home/samplingfm/Benchmarks/FeatureModels/pc_vmWare.cnf /home/samplingfm/Benchmarks/FeatureModels/moab.cnf /home/samplingfm/Benchmarks/FeatureModels/smdk2410.cnf /home/samplingfm/Benchmarks/FeatureModels/snds.cnf /home/samplingfm/Benchmarks/FeatureModels/hs7729pci.cnf /home/samplingfm/Benchmarks/FMEasy/coreboot.cnf /home/samplingfm/Benchmarks/FMEasy/2.6.32-2var.cnf /home/samplingfm/Benchmarks/FMEasy/freebsd-icse11.cnf /home/samplingfm/Benchmarks/FMEasy/2.6.33.3-2var.cnf /home/samplingfm/Benchmarks/FMEasy/embtoolkit.cnf /home/samplingfm/Benchmarks/FMEasy/freetz.cnf /home/samplingfm/Benchmarks/FMEasy/buildroot.cnf /home/samplingfm/Benchmarks/FMEasy/2.6.28.6-icse11.cnf"
VM_CMD="docker run -v /mnt/srv/tempdd/macher/usampling-exp/:/home/usampling-exp:z macher/usampling:squashed /bin/bash -c 'cd /home/usampling-exp/; echo STARTING; python3 usampling-experiments.py --kus -t 493 -flas $BENCH; echo END'"
gvirt exec $VM_NAME "$VM_WAIT_DOCKER"
gvirt exec $VM_NAME "$VM_CMD"
